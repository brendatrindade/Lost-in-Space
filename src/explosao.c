#include "proc_grafico.h"
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <stdint.h>
#include "sprite.c"

extern void inicializa_fpga();
extern void fecha_dev_mem();
extern void exibe_sprite(uint8_t sp, uint32_t xy, uint16_t offset, uint8_t registrador);
extern void altera_pixel_sprite(uint16_t cor, uint16_t endereco);

#define largura_sprite 20
#define altura_sprite 20

int usleep(useconds_t usec);
void gera_sprite_explo_ofst11();
void gera_sprite_explo_ofst12();
void gera_sprite_explo_ofst13();
void animacao();
int main();

//Dados da imagem para formar um sprite (20x20) em formato RRRGGGBB - 1 byte por pixel
uint16_t dados_da_imagem_1[altura_sprite][largura_sprite] = {
{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc4,0xf5,0xf5,0xec,0xc8,0xc0,0xc0,0x00,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0xc0,0xf5,0xff,0xff,0xff,0xfe,0xfc,0xf4,0xec,0xc0,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0xfc,0xfe,0xff,0xfc,0xfc,0xf5,0xf5,0xf4,0xec,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0xc0,0xfc,0xf5,0xf5,0xf5,0xfc,0xfe,0xfc,0xfc,0xf4,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0xc0,0xfc,0xf4,0xec,0xff,0xff,0xfc,0xfc,0xfc,0xfc,0xc0,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0xc0,0xfc,0xfc,0xf5,0xfc,0xff,0xfc,0xfc,0xec,0xc8,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0xec,0xec,0xec,0xfc,0xff,0xfc,0xf5,0xc8,0xc0,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0xc8,0xc8,0x00,0xc0,0x00,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 }
};

//Dados da imagem para formar um sprite (20x20) em formato RRRGGGBB - 1 byte por pixel
uint16_t dados_da_imagem_2[altura_sprite][largura_sprite] = {
{ 0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0xc8,0xc0,0xc0,0xc0,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0xc0,0xc0,0xc8,0xc8,0xc8,0x00,0x00,0x00,0xc0,0xc0,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0xc4,0xc4,0xc4,0xf5,0xfc,0xf5,0xf5,0xec,0xc8,0xc0,0xc0,0xc0,0xc0,0x00,0x00,0x00,0x00 },
{ 0xc0,0xc8,0xec,0xfc,0xfe,0xff,0xff,0xfc,0xff,0xff,0xfe,0xf5,0xec,0xf4,0xf5,0xec,0x00,0xc0,0xc0,0x00 },
{ 0xc0,0xc0,0xf5,0xfe,0xff,0xff,0xff,0xfe,0xff,0xff,0xfe,0xfc,0xec,0xf4,0xfc,0xec,0xc0,0xc0,0xc0,0x00 },
{ 0x00,0xc8,0xfc,0xfe,0xff,0xff,0xff,0xfe,0xfe,0xfe,0xfc,0xfc,0xf5,0xec,0xf5,0xfc,0xec,0x00,0x00,0x00 },
{ 0x00,0xec,0xfc,0xfc,0xfe,0xff,0xff,0xfc,0xfc,0xfc,0xfc,0xf5,0xfc,0xf5,0xf5,0xf4,0xf4,0xec,0xc0,0x00 },
{ 0x00,0xc8,0xfc,0xfc,0xfc,0xfe,0xfe,0xfc,0xfc,0xfc,0xfc,0xfc,0xfc,0xfc,0xfc,0xfc,0xf4,0xec,0xec,0x00 },
{ 0xc0,0xec,0xf5,0xf5,0xfc,0xfc,0xfc,0xfc,0xfc,0xf5,0xfc,0xff,0xff,0xfe,0xfc,0xfc,0xec,0xf4,0xec,0x00 },
{ 0xc0,0xec,0xfc,0xfc,0xf5,0xf5,0xf5,0xec,0xf5,0xfc,0xfc,0xfe,0xfe,0xfc,0xfc,0xfc,0xfc,0xf4,0xec,0x00 },
{ 0x00,0xec,0xfc,0xf5,0xf4,0xf4,0xf4,0xec,0xfe,0xff,0xfe,0xfc,0xfc,0xfc,0xfc,0xfc,0xfe,0xf5,0xec,0xc0 },
{ 0xc0,0xfc,0xfc,0xf5,0xf4,0xec,0xec,0xf4,0xff,0xff,0xff,0xfc,0xfc,0xfc,0xfc,0xfc,0xfc,0xfc,0xec,0xc0 },
{ 0xc0,0xfc,0xff,0xf5,0xf5,0xf4,0xf4,0xf5,0xfe,0xff,0xfe,0xfc,0xfe,0xfe,0xec,0xfc,0xf5,0xec,0xec,0xc0 },
{ 0xc0,0xfc,0xfc,0xfc,0xfc,0xf5,0xf5,0xfc,0xfc,0xfe,0xff,0xfc,0xfc,0xfc,0xfc,0xec,0xec,0xc8,0xc0,0x00 },
{ 0x00,0xc8,0xf4,0xec,0xf4,0xfc,0xf5,0xf5,0xfe,0xff,0xff,0xfe,0xfc,0xf5,0xf5,0xc8,0xc0,0x00,0x00,0x00 },
{ 0x00,0xc8,0xec,0xf4,0xec,0xf4,0xec,0xec,0xfc,0xfe,0xff,0xfc,0xfc,0xf5,0xfc,0xc8,0xc8,0xc0,0x00,0x00 },
{ 0xc0,0xec,0xc0,0xc8,0xc8,0xc0,0xc0,0xec,0xf5,0xf5,0xf5,0xf5,0xf5,0xec,0xc8,0x00,0xc0,0x00,0x00,0x00 },
{ 0x00,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0xc8,0xc8,0xc8,0xc0,0x00,0x00,0xc0,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0xc0,0x00,0x00,0x00,0x00,0xc0,0x00,0x00,0x00,0x00 }
};

//Dados da imagem para formar um sprite (20x20) em formato RRRGGGBB - 1 byte por pixel
uint16_t dados_da_imagem_3[altura_sprite][largura_sprite] = {
{ 0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0xc0,0xc0,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0xc0,0xc0,0xc8,0xc8,0xc8,0x00,0x00,0x00,0xc0,0xc0,0x00,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0xc4,0xc4,0xc4,0xf5,0x00,0xf5,0xf5,0xec,0xc8,0xc0,0xc0,0xc0,0xc0,0x00,0x00,0x00,0x00 },
{ 0xc0,0x00,0xec,0xfc,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0xf5,0x00,0x00,0xf5,0x00,0x00,0xc0,0xc0,0x00 },
{ 0xc0,0xc0,0xf5,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfc,0x00,0xc0,0xc0,0xc0,0x00 },
{ 0x00,0xc8,0x00,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xec,0x00,0xfc,0xec,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x00 },
{ 0x00,0xc8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },
{ 0xc0,0xec,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xec,0xf4,0x00,0x00 },
{ 0xc0,0xec,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf4,0x00,0x00 },
{ 0x00,0xec,0x00,0xf5,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfe,0xf5,0x00,0xc0 },
{ 0xc0,0x00,0x00,0xf5,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0 },
{ 0xc0,0x00,0x00,0xf5,0xf5,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf5,0x00,0x00,0xc0 },
{ 0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xec,0xec,0xc8,0xc0,0x00 },
{ 0x00,0xc8,0x00,0x00,0x00,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0x00,0x00 },
{ 0x00,0xc8,0xec,0x00,0x00,0x00,0xec,0xec,0xfc,0xfe,0x00,0x00,0x00,0x00,0xfc,0x00,0x00,0xc0,0x00,0x00 },
{ 0xc0,0x00,0xc0,0xc8,0xc8,0xc0,0xc0,0xec,0x00,0x00,0x00,0x00,0x00,0xec,0xc8,0x00,0xc0,0x00,0x00,0x00 },
{ 0x00,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0xc8,0xc8,0xc8,0xc0,0x00,0x00,0xc0,0x00,0x00,0x00,0x00 },
{ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0xc0,0x00,0x00,0x00,0x00,0xc0,0x00,0x00,0x00,0x00 }
};


//Converte os dados da imagem de RGB para BGR 9 bits - formato da instrucao wsm
uint16_t converte_em_bgr(uint8_t rgb) {
    uint8_t r, g, b;
    uint16_t bgr;

    //Extrai cada tom (R, G e B) do formato RGB
    r = (rgb >> 5) & 0b111; // 3 bits msb do vermelho
    g = (rgb >> 2) & 0b111; // 3 bits do meio do verde
    b = rgb & 0b11; // 2 bits lsb do azul
    //ajusta o azul de 2 para 3 bits
    b = b << 1;

    //Coloca no formato BBB GGG RRR de 9 bits
    bgr = ( (b << 6) | (g << 3) | r );

    return bgr;
}

//Cria e armazena um sprite na memoria de sprites
void cria_sprite(uint16_t end_base, uint16_t dados_do_sprite[altura_sprite][largura_sprite]) {
    uint16_t cor[400]; //20x20 -> 400 pixels por sprite
    int y, x;
    int z = 0;
    for ( y = 0; y < altura_sprite; y++) {
        for ( x = 0; x < largura_sprite; x++) {
            cor[z] = dados_do_sprite[y][x]; //Extrai a cor de cada pixel em 9 bits BGR
            z++;
        }
    }
    //Escreve cada pixel da matriz 20x20 na memoria de sprites
    int i = 0;
    while (i < 400){
        altera_pixel_sprite(cor[i], end_base + i);
        i++;
        usleep(10000);
    }
}

void gera_sprite_explo_ofst11(){
    //Dados para formar um sprite 20x20 em formato RRR GGG BBB - 9 bits
    uint16_t dados_do_sprite[altura_sprite][largura_sprite];
    uint16_t cor_temp;
    int y, x;
    for ( y = 0; y < altura_sprite; y++) {
        for ( x = 0; x < largura_sprite; x++) {
            cor_temp = dados_da_imagem_1[y][x];
            if (cor_temp == 0x00){
                dados_do_sprite[y][x] = APAGA;
            } else {
                dados_do_sprite[y][x] = converte_em_bgr(dados_da_imagem_1[y][x]);//Converte pixel por pixel do formato RGB para o BGR
            }
        }
    }
    //Escreve os dados de cada pixel na memoria de sprites. [end_base = offset * 400]
    cria_sprite(4400, dados_do_sprite);
}

void gera_sprite_explo_ofst12(){
    //Dados para formar um sprite 20x20 em formato RRR GGG BBB - 9 bits
    uint16_t dados_do_sprite[altura_sprite][largura_sprite];
    uint16_t cor_temp;
    int y, x;
    for ( y = 0; y < altura_sprite; y++) {
        for ( x = 0; x < largura_sprite; x++) {
            cor_temp = dados_da_imagem_2[y][x];
            if (cor_temp == 0x00){
                dados_do_sprite[y][x] = APAGA;
            } else {
                dados_do_sprite[y][x] = converte_em_bgr(dados_da_imagem_2[y][x]);//Converte pixel por pixel do formato RGB para o BGR
            }
        }
    }
    //Escreve os dados de cada pixel na memoria de sprites. [end_base = offset * 400]
    cria_sprite(4800, dados_do_sprite);
}

void gera_sprite_explo_ofst13(){
    //Dados para formar um sprite 20x20 em formato RRR GGG BBB - 9 bits
    uint16_t dados_do_sprite[altura_sprite][largura_sprite];
    uint16_t cor_temp;
    int y, x;
    for ( y = 0; y < altura_sprite; y++) {
        for ( x = 0; x < largura_sprite; x++) {
            cor_temp = dados_da_imagem_3[y][x];
            if (cor_temp == 0x00){
                dados_do_sprite[y][x] = APAGA;
            } else {
                dados_do_sprite[y][x] = converte_em_bgr(dados_da_imagem_3[y][x]);//Converte pixel por pixel do formato RGB para o BGR
            }
            dados_do_sprite[y][x] = converte_em_bgr(dados_da_imagem_3[y][x]);//Converte pixel por pixel do formato RGB para o BGR
        }
    }
    //Escreve os dados de cada pixel na memoria de sprites. [end_base = offset * 400]
    cria_sprite(5200, dados_do_sprite);
}

void animacao(){
    #define mascara_10bits 0b1111111111
    #define limite_superior_eixoY 10
    #define limite_inferior_eixoY 450
    #define limite_esquerdo_eixoX 10
    #define limite_direito_eixoX 610

    uint16_t pos_x = 300;
    uint16_t pos_y = 280;

    pos_x &= mascara_10bits;
    pos_y &= mascara_10bits;
    
    uint32_t pos_xy_20b;
    pos_xy_20b = (pos_x << 10 | pos_y);
    
    gera_sprite_explo_ofst11();
    gera_sprite_explo_ofst12();
    gera_sprite_explo_ofst13();

    while (1) {    
        int i;
        for (i=11; i<14; i++){
            exibe_sprite(1, pos_xy_20b, i, 3);
            usleep(100000);
        }
    }
}

int main() {
    inicializa_fpga();

    animacao();

    fecha_dev_mem();   
    return 0;
}